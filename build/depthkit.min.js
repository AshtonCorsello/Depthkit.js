!function e(n,t,i){function o(a,s){if(!t[a]){if(!n[a]){var l="function"==typeof require&&require;if(!s&&l)return l(a,!0);if(r)return r(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var f=t[a]={exports:{}};n[a][0].call(f.exports,function(e){var t=n[a][1][e];return o(t||e)},f,f.exports,e,n,t,i)}return t[a].exports}for(var r="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}({1:[function(e,n,t){"use strict";function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),r={emitDelay:10,strictMode:!1},a=function(){function e(){var n=arguments.length<=0||void 0===arguments[0]?r:arguments[0];i(this,e);var t=void 0,o=void 0;t=n.hasOwnProperty("emitDelay")?n.emitDelay:r.emitDelay,this._emitDelay=t,o=n.hasOwnProperty("strictMode")?n.strictMode:r.strictMode,this._strictMode=o,this._listeners={},this.events=[]}return o(e,[{key:"_addListenner",value:function(e,n,t){if("function"!=typeof n)throw TypeError("listener must be a function");-1===this.events.indexOf(e)?(this._listeners[e]=[{once:t,fn:n}],this.events.push(e)):this._listeners[e].push({once:t,fn:n})}},{key:"on",value:function(e,n){this._addListenner(e,n,!1)}},{key:"once",value:function(e,n){this._addListenner(e,n,!0)}},{key:"off",value:function(e,n){var t=this,i=this.events.indexOf(e);e&&-1!==i&&(n?function(){var o=[],r=t._listeners[e];r.forEach(function(e,t){e.fn===n&&o.unshift(t)}),o.forEach(function(e){r.splice(e,1)}),r.length||(t.events.splice(i,1),delete t._listeners[e])}():(delete this._listeners[e],this.events.splice(i,1)))}},{key:"_applyEvents",value:function(e,n){var t=this._listeners[e];if(t&&t.length){var i=[];t.forEach(function(e,t){e.fn.apply(null,n),e.once&&i.unshift(t)}),i.forEach(function(e){t.splice(e,1)})}else if(this._strictMode)throw"No listeners specified for event: "+e}},{key:"emit",value:function(e){for(var n=this,t=arguments.length,i=Array(t>1?t-1:0),o=1;o<t;o++)i[o-1]=arguments[o];this._emitDelay?setTimeout(function(){n._applyEvents.call(n,e,i)},this._emitDelay):this._applyEvents(e,i)}},{key:"emitSync",value:function(e){for(var n=arguments.length,t=Array(n>1?n-1:0),i=1;i<n;i++)t[i-1]=arguments[i];this._applyEvents(e,t)}},{key:"destroy",value:function(){this._listeners={},this.events=[]}}]),e}();n.exports=a},{}],2:[function(e,n,t){n.exports=function(e){"string"==typeof e&&(e=[e]);for(var n=[].slice.call(arguments,1),t=[],i=0;i<e.length-1;i++)t.push(e[i],n[i]||"");return t.push(e[i]),t.join("")}},{}],3:[function(e,n,t){"use strict";function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function o(e,n){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!n||"object"!=typeof n&&"function"!=typeof n?e:n}function r(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function, not "+typeof n);e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),n&&(Object.setPrototypeOf?Object.setPrototypeOf(e,n):e.__proto__=n)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,n){for(var t=0;t<n.length;t++){var i=n[t];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(n,t,i){return t&&e(n.prototype,t),i&&e(n,i),n}}(),s=function(e){return e&&e.__esModule?e:{default:e}}(e("event-emitter-es6")),l=e("glslify"),u=function(e){function n(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"mesh",r=arguments[1],a=arguments[2];arguments[3];i(this,n);var s=o(this,(n.__proto__||Object.getPrototypeOf(n)).call(this)),u=l(["#define GLSLIFY 1\nuniform sampler2D map;\nuniform float opacity;\n\nuniform float uvdy;\nuniform float uvdx;\n\nvarying float visibility;\nvarying vec2 vUv;\nvarying vec3 vNormal;\nvarying vec3 vPos;\n\nvoid main() {\n\n    if ( visibility < 0.75 ) discard;\n\n    vec4 color = texture2D( map, vUv + vec2(uvdx, uvdy));\n    color.w = opacity;\n\n    gl_FragColor = color;\n    \n}"]),f=l(["#define GLSLIFY 1\nuniform float mindepth;\nuniform float maxdepth;\n\nuniform float width;\nuniform float height;\n\nuniform bool isPoints;\nuniform float pointSize;\n\nuniform float time;\n\nvarying vec3 vNormal;\nvarying vec3 vPos;\n\n//TODO: make uniforms\nconst float fx = 1.11087;\nconst float fy = 0.832305;\n\nuniform sampler2D map;\n\n//Making z global\nfloat z;\n\nvarying float visibility;\nvarying vec2 vUv;\n\nvec3 rgb2hsl( vec3 color ) {\n    float h = 0.0;\n    float s = 0.0;\n    float l = 0.0;\n    float r = color.r;\n    float g = color.g;\n    float b = color.b;\n    float cMin = min( r, min( g, b ) );\n    float cMax = max( r, max( g, b ) );\n    l =  ( cMax + cMin ) / 2.0;\n    if ( cMax > cMin ) {\n        float cDelta = cMax - cMin;\n        // saturation\n        if ( l < 0.5 ) {\n            s = cDelta / ( cMax + cMin );\n        } else {\n            s = cDelta / ( 2.0 - ( cMax + cMin ) );\n        }\n\n        // hue\n        if ( r == cMax ) {\n            h = ( g - b ) / cDelta;\n        } else if ( g == cMax ) {\n            h = 2.0 + ( b - r ) / cDelta;\n        } else {\n            h = 4.0 + ( r - g ) / cDelta;\n        }\n\n        if ( h < 0.0) {\n            h += 6.0;\n        }\n        h = h / 6.0;\n\n    }\n    return vec3( h, s, l );\n}\n\nvec3 xyz( float x, float y, float depth ) {\n    z = depth * ( maxdepth - mindepth ) + mindepth;\n    return vec3( ( x / height  ) * z * fx, ( y / (width * 2.0)  ) * z * fy, - z );\n}\n\nvoid main() {\n\n    vUv = vec2( ( position.x + 512.0 ) / 1024.0 , ( position.y + 512.0  ) / 1024.0 );\n\n    vUv.y = vUv.y * 0.5;// + 0.5;\n\n    vPos = (modelMatrix * vec4(position, 1.0 )).xyz;\n    vNormal = normalMatrix * normal;\n\n    vec3 hsl = rgb2hsl( texture2D( map, vUv ).xyz );\n    vec4 pos = vec4( xyz( position.x, position.y, hsl.x ), 1.0 );\n    pos.z += 2600.0;\n\n    visibility = hsl.z * 2.1;\n\n    if(isPoints){\n        gl_PointSize = pointSize;\n    }\n\n    gl_Position = projectionMatrix * modelViewMatrix * pos;\n}"]);switch(s.VERTS_WIDE=256,s.VERTS_TALL=256,s.video=document.createElement("video"),s.video.crossOrigin="anonymous",s.video.setAttribute("crossorigin","anonymous"),s.video.src=a,s.video.autoplay=!1,s.video.loop=!1,s.videoTexture=new THREE.VideoTexture(s.video),s.videoTexture.minFilter=THREE.NearestFilter,s.videoTexture.magFilter=THREE.LinearFilter,s.videoTexture.format=THREE.RGBFormat,s.videoTexture.generateMipmaps=!1,s.manager=new THREE.LoadingManager,s.props,s.geo=s.buildGeomtery(),s.material=new THREE.ShaderMaterial({uniforms:{diffuse:{type:"c",value:new THREE.Color(255)},map:{type:"t",value:s.videoTexture},time:{type:"f",value:0},mindepth:{type:"f",value:0},maxdepth:{type:"f",value:0},uvdy:{type:"f",value:.5},uvdx:{type:"f",value:0},width:{type:"f",value:0},height:{type:"f",value:0},opacity:{type:"f",value:1},isPoints:{type:"b",value:!1},pointSize:{type:"f",value:3}},vertexShader:f,fragmentShader:u,transparent:!0}),s.material.side=THREE.DoubleSide,t){case"wire":s.material.wireframe=!0,s.mesh=new THREE.Mesh(s.geo,s.material);break;case"points":s.material.uniforms.isPoints.value=!0,s.mesh=new THREE.Points(s.geo,s.material);break;default:s.mesh=new THREE.Mesh(s.geo,s.material)}return s.jsonLoader=new THREE.FileLoader(s.manager),s.jsonLoader.setResponseType("json"),s.jsonLoader.load(r,function(e){s.props=e,console.log(s.props),s.material.uniforms.width.value=s.props.textureWidth,s.material.uniforms.height.value=s.props.textureHeight,s.material.uniforms.mindepth.value=s.props.nearClip,s.material.uniforms.maxdepth.value=s.props.farClip}),s.mesh.depthkit=s,e=s.mesh,o(s,e)}return r(n,s.default),a(n,[{key:"buildGeomtery",value:function(){for(var e=new THREE.Geometry,n=0;n<this.VERTS_TALL;n++)for(var t=0;t<this.VERTS_WIDE;t++)e.vertices.push(new THREE.Vector3(5*t-640,480-5*n,0));for(var i=0;i<this.VERTS_TALL-1;i++)for(var o=0;o<this.VERTS_WIDE-1;o++)e.faces.push(new THREE.Face3(o+i*this.VERTS_WIDE,o+(i+1)*this.VERTS_WIDE,o+1+i*this.VERTS_WIDE)),e.faces.push(new THREE.Face3(o+1+i*this.VERTS_WIDE,o+(i+1)*this.VERTS_WIDE,o+1+(i+1)*this.VERTS_WIDE));return e}},{key:"setPointSize",value:function(e){this.material.uniforms.isPoints.value?this.material.uniforms.pointSize.value=e:console.warn("Can not set point size because the current character is not set to render points")}},{key:"setOpacity",value:function(e){this.material.uniforms.opacity.value=e}},{key:"play",value:function(){this.video.isPlaying?console.warn("Can not play because the character is already playing"):this.video.play()}},{key:"stop",value:function(){this.video.currentTime=0,this.video.pause()}},{key:"pause",value:function(){this.video.pause()}},{key:"setLoop",value:function(e){this.video.loop=e}},{key:"setVolume",value:function(e){this.video.volume=e}},{key:"update",value:function(e){this.material.uniforms.time.value=e}},{key:"dispose",value:function(){}}]),n}();t.default=u},{"event-emitter-es6":1,glslify:2}],4:[function(e,n,t){"use strict";var i=function(e){return e&&e.__esModule?e:{default:e}}(e("./depthkit"));window.DepthKit=i.default},{"./depthkit":3}]},{},[4]);
